import{L as H,r as v,x as F}from"./main-BT7iXV3b.js";const Z=H("prediction",()=>{const M=v(null),P=v(null),d=v([]),b=v(!1),S=v(null),u=v([]),C=v(!1),w=v(null);async function K(n,g="auto"){try{b.value=!0,S.value=null;const s=await F.predict(n,g);if(s.success){M.value=n,P.value=s;try{await L(n,6),P.value.recommendedFoods=u.value||[]}catch(h){console.warn("Failed to fetch recommendations:",h)}d.value.unshift({input:n,result:s,timestamp:new Date().toISOString()}),d.value.length>10&&d.value.pop(),R()}return s}catch(s){throw S.value=s.message,s}finally{b.value=!1}}async function x(n,g=!0){try{return b.value=!0,S.value=null,await F.batchPredict(n,g)}catch(s){throw S.value=s.message,s}finally{b.value=!1}}async function L(n,g=5){try{C.value=!0,w.value=null;const s=["Energy_kcal_per_serving","Protein_g_per_serving","Fat_g_per_serving","Carbohydrates_g_per_serving","Fiber_g_per_serving","Calcium_mg_per_serving","Iron_mg_per_serving","Magnesium_mg_per_serving","Phosphorus_mg_per_serving","Potassium_mg_per_serving","Sodium_mg_per_serving","Zinc_mg_per_serving","VitaminA_ug_per_serving","VitaminC_mg_per_serving"],h=s.map(a=>n&&n[a]!=null?Number(n[a]):0);let f=null;try{f=await F.getRecommendations({vector:h,top_k:Math.max(g,20)})}catch{f=null}let y=[];try{const a=await F.getLocalFoods();Array.isArray(a)&&(y=a)}catch(a){console.warn("Could not fetch local foods for enrichment:",a)}const V=["central","western","eastern","northern"],_=n&&typeof n.region_encoded=="number"?V[n.region_encoded]:null,A=n&&(n.estimated_cost_ugx||n.budget),q=a=>{const r={},t={};return a.forEach(o=>{if(!o)return;const e=(o.name||o.title||"").toString().toLowerCase();e&&(r[e]=o),o.id!=null&&(t[String(o.id)]=o)}),{byName:r,byId:t}},{byName:G,byId:X}=q(y),z=a=>{const r=a&&a.meta||{},t=(r.name||r.title||a.id||"").toString().toLowerCase(),o=X[String(a.id)]||G[t],e=Object.assign({},r,o||{});return Object.assign({},a,{meta:e})};let m=[];if(f&&f.success&&Array.isArray(f.items)&&f.items.length){if(m=f.items.map(z),m.some(r=>r.meta&&typeof r.meta.available<"u")){const r=m.filter(t=>t.meta&&t.meta.available!==!1);r.length&&(m=r)}if(m.sort((r,t)=>{const o=(r.meta&&(r.meta.region||r.meta.region_name||r.meta.region_str)||"").toString().toLowerCase(),e=(t.meta&&(t.meta.region||t.meta.region_name||t.meta.region_str)||"").toString().toLowerCase(),i=_&&o===_?1:0,c=_&&e===_?1:0;if(c!==i)return c-i;const l=(t.score||0)-(r.score||0);if(l!==0)return l;const N=r.meta&&(r.meta.pricePerKg||r.meta.price_per_kg||r.meta.price)||Number.MAX_SAFE_INTEGER,p=t.meta&&(t.meta.pricePerKg||t.meta.price_per_kg||t.meta.price)||Number.MAX_SAFE_INTEGER;return N-p}),A){const r=m.filter(t=>{const o=t.meta&&(t.meta.pricePerKg||t.meta.price_per_kg||t.meta.price)||null;return o==null?!0:Number(o)<=Number(A)*2});r.length&&(m=r)}return m=m.slice(0,g),u.value=m,u.value}if(y&&y.length){const a=h&&Array.isArray(h)?h.map(e=>Number(e)||0):null,r=e=>{const i={Energy_kcal_per_serving:Number(e.energy)||0,Protein_g_per_serving:Number(e.protein)||0,Fat_g_per_serving:Number(e.fat)||0,Carbohydrates_g_per_serving:Number(e.carbs)||0,Fiber_g_per_serving:Number(e.fiber)||0,Calcium_mg_per_serving:Number(e.calcium)||0,Iron_mg_per_serving:Number(e.iron)||0,Magnesium_mg_per_serving:0,Phosphorus_mg_per_serving:0,Potassium_mg_per_serving:0,Sodium_mg_per_serving:0,Zinc_mg_per_serving:0,VitaminA_ug_per_serving:0,VitaminC_mg_per_serving:0};return s.map(c=>Number(i[c]||0))},t=[];if(a&&a.length){const e=Math.sqrt(a.reduce((i,c)=>i+c*c,0))||1;for(const i of y)try{if(typeof i.available<"u"&&i.available===!1)continue;_&&(i.region||"").toString().toLowerCase();const c=r(i),l=Math.sqrt(c.reduce((I,E)=>I+E*E,0))||1;let p=c.reduce((I,E,j)=>I+E*(a[j]||0),0)/(e*l);isFinite(p)||(p=0),p=Math.max(0,Math.min(1,p)),t.push({id:i.id||i.name,score:p,meta:i})}catch{continue}if(t.length){t.sort((c,l)=>(l.score||0)-(c.score||0));let i=t.slice(0,g);if(A){const c=i.filter(l=>{const N=l.meta&&(l.meta.pricePerKg||l.meta.price_per_kg||l.meta.price)||null;return N==null?!0:Number(N)<=Number(A)*2});c.length&&(i=c)}return u.value=i,u.value}}let o=[...y];if(o.some(e=>typeof e.available<"u")&&(o=o.filter(e=>e.available!==!1)),_){const e=o.filter(i=>(i.region||"").toString().toLowerCase()===_);e.length&&(o=e)}return o.sort((e,i)=>(e.pricePerKg||Number.MAX_SAFE_INTEGER)-(i.pricePerKg||Number.MAX_SAFE_INTEGER)),u.value=o.slice(0,g).map(e=>({id:e.name||e.id,score:0,meta:e})),u.value}return w.value="No recommendations available",[]}catch(s){throw w.value=s.message||String(s),s}finally{C.value=!1}}function O(){M.value=null,P.value=null}function T(){d.value=[],localStorage.removeItem("mzeechakula_history")}function R(){try{localStorage.setItem("mzeechakula_history",JSON.stringify(d.value))}catch(n){console.error("Failed to save to localStorage:",n)}}function k(){try{const n=localStorage.getItem("mzeechakula_history");n&&(d.value=JSON.parse(n))}catch(n){console.error("Failed to load from localStorage:",n)}}return k(),{currentInput:M,currentPrediction:P,predictionHistory:d,recommendations:u,loading:b,error:S,recLoading:C,recError:w,predict:K,batchPredict:x,fetchRecommendations:L,clearCurrent:O,clearHistory:T,saveToLocalStorage:R,loadFromLocalStorage:k}});export{Z as u};
